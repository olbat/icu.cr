---
language: crystal
sudo: required

matrix:
  include:
  # Linux
  - os: linux
    dist: precise
  - os: linux
    dist: trusty
  # FIXME: no proper Travis CI Xenial image
  #- os: linux
  #  dist: xenial
  - os: linux
    dist: trusty
    env: GENERATE_LIB=1 # regenerate the binding

  # macOS
  - os: osx
    osx_image: xcode8.3
  - os: osx
    osx_image: xcode8.3
    env: GENERATE_LIB=1 # regenerate the binding

  # publish the documentation on GitHub pages
  - os: linux
    stage: deploy
    install:
    script: crystal docs
    deploy:
      provider: pages
      local_dir: doc/
      target_branch: gh-pages
      github_token: $GITHUB_TOKEN
      skip_cleanup: true
      on:
        branch: master

  # triggers an image build (used with travis' cron jobs to build periodically)
  - stage: deploy
    os: linux
    before_install:
    script: >
      [ $TRAVIS_EVENT_TYPE != "cron" ] ||
      curl -H "Content-Type: application/json" --data '{"build": true}'
      -X POST https://registry.hub.docker.com/u/olbat/libgen/trigger/${DOCKER_TOKEN}/

install: |
  case $TRAVIS_OS_NAME in
  linux)
    sudo apt-get -qq update
    if [[ -n $GENERATE_LIB ]]; then
      sudo apt-get install -y llvm-3.8-dev libclang-3.8-dev
      # FIXME: ugly fix since the libclang-3.8-dev package is bugged
      sudo ln -s $(llvm-config-3.8 --libdir)/libclang.so /usr/lib/
    fi
    sudo apt-get install -y libicu-dev
    ;;
  osx)
    brew update

    if [[ -n $GENERATE_LIB ]]; then
      # install LLVM and Clang 3.8 (a libgen dependency)
      brew install llvm@3.8
      # FIXME: ugly fix since the libclang.dylib is not symlinked correctly
      brew list --verbose llvm@3.8 | grep "\.dylib$" | xargs -n1 -I{} ln -sf {} $(brew --prefix)/lib
    fi

    brew install icu4c
    brew link --force icu4c
    ;;
  *)
    exit 1;;
  esac

before_script:
- crystal run src/icu_info.cr -- --version # displays the version of ICU
- "[ -z $GENERATE_LIB ] || make"

script:
  crystal tool format --check src spec bench
  && crystal spec
  && make benchmark
