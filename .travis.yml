---
language: crystal
sudo: required

matrix:
  include:
  # Linux
  - os: linux
    dist: precise
  - os: linux
    dist: trusty
  - os: linux
    dist: xenial
  - os: linux
    dist: trusty
    env: GENERATE_LIB=1 # regenerate the binding

  # macOS
  - os: osx
    osx_image: xcode8.3
  - os: osx
    osx_image: xcode8.3
    env: GENERATE_LIB=1 # regenerate the binding

  # publish the documentation on GitHub pages
  - os: linux
    stage: deploy
    before_install:
    script: crystal docs
    deploy:
      provider: pages
      local_dir: doc/
      target_branch: gh-pages
      github_token: $GITHUB_TOKEN
      skip_cleanup: true
      on:
        branch: master

before_install: |
  case $TRAVIS_OS_NAME in
  linux)
    sudo apt-get -qq update
    if [[ -n $GENERATE_LIB ]]; then
      sudo apt-get install -y llvm-3.5-dev libclang-3.5-dev
    fi
    sudo apt-get install -y libicu-dev
    ;;
  osx)
    brew update

    if [[ -n $GENERATE_LIB ]]; then
      # install LLVM and Clang 3.7 (a libgen dependency)
      brew install llvm@3.7
      # FIXME: ugly fix since the libclang.dylib is not symlinked correctly
      brew list --verbose llvm@3.7 | grep "\.dylib$" | xargs -n1 -I{} ln -sf {} $(brew --prefix)/lib
    fi

    brew install icu4c
    brew link --force icu4c
    ;;
  *)
    exit 1;;
  esac

before_script:
- "[ -z $GENERATE_LIB ] || make"

script:
- crystal tool format --check src spec bench
- crystal spec
- make benchmark
